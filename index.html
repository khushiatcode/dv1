<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>California Waste Characterization Analytics</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0/dist/chartjs-chart-treemap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            scroll-behavior: smooth;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            background: #0a0e1a;
        }
        
        .chart-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            transition: all 0.8s ease-in-out;
            opacity: 0;
            transform: scale(1.05);
            z-index: 1;
            pointer-events: none;
            display: none;
            overflow-y: auto;
            padding: 2rem;
        }
        
        .chart-container.visible {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            opacity: 0.3;
            pointer-events: auto;
        }
        
        .chart-container.active {
            opacity: 1;
            transform: scale(1);
            z-index: 15;
            pointer-events: auto;
        }
        
        .narrative-container {
            position: relative;
            z-index: 10;
        }
        
        .narrative-section {
            min-height: 250vh;
            position: relative;
        }
        
        .narrative-panel {
            position: sticky;
            top: 50%;
            transform: translateY(-50%) scale(0.9);
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 1rem;
            padding: 3rem;
            max-width: 700px;
            margin: 0 auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: all 0.8s ease-out;
            z-index: 20;
        }
        
        .narrative-panel.active {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }
        
        .narrative-panel.exit {
            opacity: 0;
            transform: translateY(-150%) scale(0.9);
        }
        
        .section-wrapper {
            height: 200vh;
            position: relative;
        }
        
        .chart-section {
            height: 100vh;
            position: sticky;
            top: 0;
        }
        
        .content-section {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .metric-highlight {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            font-size: 2.5rem;
        }
        
        .section-title {
            color: #e2e8f0;
            font-size: 1.875rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .section-text {
            color: #cbd5e1;
            font-size: 1.125rem;
            line-height: 1.7;
            margin-bottom: 1.5rem;
        }
        
        .progress-indicator {
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 20;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 0.5rem;
            padding: 1rem;
            min-width: 150px;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(99, 102, 241, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-indicator .text-sm {
            color: #ffffff;
        }
        
        .chart-canvas {
            width: 100% !important;
            height: calc(100vh - 4rem) !important;
            background: transparent;
            max-width: 1400px;
            margin: 0 auto;
            touch-action: pan-y pinch-zoom;
        }
        
        .intro-section {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.9));
        }
        
        .intro-content {
            text-align: center;
            max-width: 800px;
            padding: 2rem;
        }
        
        .main-title {
            font-size: 3.5rem;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #60a5fa, #a78bfa, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            font-size: 1.5rem;
            color: #94a3b8;
            margin-bottom: 2rem;
        }
        
        .scroll-indicator {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            color: #64748b;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateX(-50%) translateY(0); }
            40% { transform: translateX(-50%) translateY(-10px); }
            60% { transform: translateX(-50%) translateY(-5px); }
        }
        
        .fade-in {
            animation: fadeIn 1s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        select option {
            background-color: #1e293b;
            color: #e2e8f0;
            padding: 8px;
        }

        /* Select Container Styles */
        .select-controls {
            position: absolute;
            top: 1.5rem;
            left: 1.5rem;
            z-index: 20;
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .text-slate-300{
            color: #ffffff;
        }

        .select-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .select-label {
            color: #e2e8f0;
            font-size: 0.875rem;
            font-weight: 500;
        }

        select {
            background-color: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 0.5rem;
            color: #ffffff;
            font-size: 0.875rem;
            padding: 0.5rem 2rem 0.5rem 1rem;
            appearance: none;
            cursor: pointer;
            backdrop-filter: blur(10px);
            min-width: 160px;
            transition: all 0.2s ease;
        }

        select:hover {
            border-color: rgba(99, 102, 241, 0.5);
            background-color: rgba(15, 23, 42, 0.9);
        }

        select:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.8);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        /* Custom select arrow */
        .select-wrapper {
            position: relative;
        }

        .text-slate-400{
            color: #ffffff;
        }

        .select-wrapper::after {
            content: '▼';
            font-size: 0.7rem;
            color: #94a3b8;
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- Progress Indicator -->
    <div class="progress-indicator">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="text-sm text-slate-300">
            <span id="currentSection">Introduction</span>
        </div>
    </div>

    <!-- Chart Containers -->
    <div id="introChart" class="chart-container">
        <div class="select-controls">
            <div class="select-group">
                <label for="sectorSelect" class="select-label">Select Sector:</label>
                <div class="select-wrapper">
                    <select id="sectorSelect" class="bg-slate-900/80 text-slate-200 border border-slate-700 rounded-lg px-4 py-2 text-sm font-medium backdrop-blur-sm transition-all hover:bg-slate-800/80 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50">
                        <option value="statewide">Statewide Total</option>
                        <option value="residential">Residential (Single-family)</option>
                        <option value="commercial">Commercial (including Multi-family)</option>
                        <option value="selfhaul">Self-Haul</option>
                        <option value="transfer">Transfer Truck</option>
                    </select>
                </div>
            </div>
        </div>
        <canvas id="introCanvas" class="chart-canvas"></canvas>
    </div>
    
    <div id="correlationChart" class="chart-container hidden">
        <div class="select-controls">
            <div class="select-group">
                <label for="materialSelect" class="select-label">Material Category:</label>
                <div class="select-wrapper">
                    <select id="materialSelect" class="bg-slate-900/80 text-slate-200 border border-slate-700 rounded-lg px-4 py-2 text-sm font-medium backdrop-blur-sm transition-all hover:bg-slate-800/80 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50">
                        <option value="ORGANICS">Organics</option>
                        <option value="PAPER">Paper</option>
                        <option value="PLASTIC">Plastic</option>
                        <option value="MIXED RESIDUE">Mixed Residue</option>
                        <option value="INERTS AND OTHER">Inerts and Other</option>
                        <option value="GLASS">Glass</option>
                        <option value="METAL">Metal</option>
                    </select>
                </div>
            </div>
            <div class="select-group">
                <label for="metricSelect" class="select-label">Metric:</label>
                <div class="select-wrapper">
                    <select id="metricSelect" class="bg-slate-900/80 text-slate-200 border border-slate-700 rounded-lg px-4 py-2 text-sm font-medium backdrop-blur-sm transition-all hover:bg-slate-800/80 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50">
                        <option value="percentage">Percentage (%)</option>
                        <option value="tonnage">Tonnage</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="w-full h-full pt-20 px-4">
            <div class="relative w-full h-full">
                <canvas id="comparisonChartCanvas"></canvas>
            </div>
        </div>
    </div>
    
    <div id="clustersChart" class="chart-container hidden">
        <canvas id="clustersCanvas" class="chart-canvas"></canvas>
    </div>
    
   
    
    <div id="forecastChart" class="chart-container hidden">
        <canvas id="forecastCanvas" class="chart-canvas"></canvas>
    </div>
    
    <div id="carbonChart" class="chart-container hidden">
        <canvas id="carbonCanvas" class="chart-canvas"></canvas>
    </div>

    <div id="mlChart" class="chart-container hidden">
        <canvas id="mlCanvas" class="chart-canvas"></canvas>
    </div>
    

    <!-- Narrative Container -->
    <div class="narrative-container">
        <section class="narrative-section" data-section="0" data-chart="intro">
            <div class="narrative-panel">
                <h1 class="main-title">California Waste Characterization Analytics</h1>
                <p class="subtitle">2021 Disposal Facility-based Study </p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mt-12">
                    <div class="text-center">
                        <div class="metric-highlight">39.9M</div>
                        <div class="text-slate-400">Total Tons Disposed</div>
                    </div>
                    <div class="text-center">
                        <div class="metric-highlight">65%</div>
                        <div class="text-slate-400">Potentially Recyclable</div>
                    </div>
                    <div class="text-center">
                        <div class="metric-highlight">6</div>
                        <div class="text-slate-400">Waste Sectors Analyzed</div>
                    </div>
                </div>
            </div>
        </section>
        <!-- Introduction Section -->
        <section class="narrative-section" data-section="0" data-chart="intro">
            <div class="narrative-panel">
                <h1 style="font-size: 1.5rem;" class="main-title">Treemap — Who’s Filling Up the Landfills?</h1>
                <p class="subtitle">Built using D3.js, this treemap maps the 🏋️‍♂️ top 15 materials by tonnage from the 2021 CalRecycle study.</p>
                <div class="text-slate-300 mt-1">📦 Cardboard, 🍽️ food waste, and 🛍️ plastic film take up the most space — even though most are recyclable or compostable.</div>
                <div class="text-slate-300 mt-1">🔍 Each block’s size = landfill volume.</div>
                <div class="text-slate-300 mt-1">🛠️ Method: Hierarchical layout using material tonnage as weight.</div>
                <div class="text-slate-300 mt-1">🎯 Use: Helps prioritize volume-based diversion policies like composting and packaging reform.</div>
            </div>
        </section>

        <!-- Recovery Potential Section -->
        <section class="narrative-section" data-section="1" data-chart="correlation">
            <div class="narrative-panel">
                <h2 class="section-title">Bar Chart — Who’s Throwing What?</h2>
                <p class="section-text">
                    This bar chart compares across 🏠 residential, 🏢 commercial, 🛻 self-haul, and 🚚 transfer sectors.
                </p>
                <p style="margin-bottom: 1px;" class="section-text">
                    Residential streams lean organic, while commercial ones skew plastic and paper-heavy.
                </p>
                <p style="margin-bottom: 1px;" class="section-text">
                    🛠️ Built with: Chart.js using sector-segmented data.
                </p>
                <p style="margin-bottom: 1px;" class="section-text">
                    📈 Insight: Waste varies by source — and so should policy.
                </p>
                <p style="margin-bottom: 1px;" class="section-text">
                    🎯 Use: Design sector-specific diversion strategies (e.g., compost bins for homes, e-waste for offices).
                </p>
            </div>
        </section>

        <!-- Cross-Sector Correlations Section -->
        <section class="narrative-section" data-section="2" data-chart="clusters">
            <div class="narrative-panel">
                <h2 class="section-title">Radar Chart — What’s Worth Recovering</h2>
                <p style="margin-bottom: 2px;" class="section-text">
                    🧭 Plots materials by ♻️ recoverability and 💰 market value
                </p>
                <p style="margin-bottom: 2px;" class="section-text">
                    🥇 Aluminum & 💻 e-waste = high recovery ROI | 🪵 Treated wood = low return
                </p>
                <p style="margin-bottom: 2px;" class="section-text">
                    🤖 ML model: K-Means clustering on recovery × value × tonnage
                </p>
                <p style="margin-bottom: 2px;" class="section-text">
                    🛠 Built with: Radar chart using ML-ranked recovery scores
            </div>
        </section>

       
        <!-- ML Performance Section -->
        <!-- <section class="narrative-section" data-section="4" data-chart="forecast">
            <div class="narrative-panel">
                <h2 class="section-title">Predictive Intelligence</h2>
                <p class="section-text">
                    Our Random Forest model achieves <span class="metric-highlight text-2xl">94.7%</span> accuracy in predicting waste generation patterns.
                </p>
                <p class="section-text">
                    Top predictive factors identified:
                </p>
                <div class="space-y-3 mt-6">
                    <div class="flex justify-between items-center">
                        <span class="text-slate-300">Sector Type</span>
                        <span class="text-blue-400 font-bold">35%</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-slate-300">Material Density</span>
                        <span class="text-green-400 font-bold">28%</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-slate-300">Seasonal Patterns</span>
                        <span class="text-purple-400 font-bold">22%</span>
                    </div>
                </div>
            </div> -->
        </section>

        <!-- Forecasting Section -->
        <!-- <section class="narrative-section" data-section="5" data-chart="carbon">
            <div class="narrative-panel">
                <h2 class="section-title">Future Waste Projections</h2>
                <p class="section-text">
                    Predictive models forecast an <span class="text-orange-400 font-bold">8.3% increase</span> in organic waste generation by 2025.
                </p>
                <p class="section-text">
                    This projection indicates immediate infrastructure scaling requirements for composting facilities statewide.
                </p>
                <div class="mt-6 p-4 bg-orange-900/30 rounded-lg border border-orange-500/30">
                    <div class="text-orange-300 font-medium">Urgent Action Required</div>
                    <div class="text-slate-300 mt-1">Current composting capacity will be exceeded by 2024 without intervention.</div>
                </div>
            </div>
        </section> -->

        <!-- Carbon Impact Section -->
        <section class="narrative-section" data-section="6" data-chart="carbon">
            <div class="narrative-panel">
                <h2 class="section-title">Donut Chart — Which Waste Pollutes the Most</h2>
                <p style="margin-bottom: 2px;" class="section-text">
                    🍩 Shows carbon footprint per ton by material
                </p>
                <p style="margin-bottom: 2px;" class="section-text">
                    🪵 Treated wood = low volume, but very high CO₂ emissions
                </p>
                <p style="margin-bottom: 2px;" class="section-text">
                    🤖 ML model: Monte Carlo simulation using emissions-per-ton ranges
                </p>
                <p style="margin-bottom: 2px;" class="section-text">
                    🛠 Built with: Chart.js donut chart + emissions database
            </div>
        </section>

         <!-- Behavioral Clusters Section -->
        <section class="narrative-section" data-section="3" data-chart="ml">
            <div class="narrative-panel">
                <h2 class="section-title">Cluster Chart —Finding Hidden Waste Behaviors</h2>
                <p style="margin-bottom: 2px;" class="section-text">
                    🤖 Model: K-Means clustering on recovery %, value/ton, and volume
                </p>
                <p style="margin-bottom: 2px;" class="section-text">
                    🔵 Cluster 1: Recyclable-rich — metals, cardboard, glass
                </p>
                <p style="margin-bottom: 2px;" class="section-text">
                    🟢 Cluster 2: Organic-heavy — food, yard waste, treated wood
                </p>
                <p style="margin-bottom: 2px;" class="section-text">
                    🔴 Cluster 3: Problematic mix — diapers, residues, contaminated plastics
                * 🛠 Built with: Bubble chart (X = recovery %, Y = $/ton, size = tonnage, color = cluster)
                * 🎯 Use: Helps cities plan smarter recovery systems — e.g., compost Cluster 2, redesign Cluster 3, scale up recycling for Cluster 1
               
            </div>
        </section>


        <!-- Optimization Section -->
        <!-- <section class="narrative-section" data-section="7" data-chart="optimization">
            <div class="narrative-panel">
                <h2 class="section-title">Optimization Opportunities</h2>
                <p class="section-text">
                    Economic-environmental analysis reveals aluminum cans as the perfect optimization target: <span class="text-green-400 font-bold">95% recovery rate</span>, <span class="text-blue-400">$1,500/ton value</span>, and lowest carbon intensity.
                </p>
                <p class="section-text">
                    Commercial sector offers <span class="metric-highlight text-xl">2.3x better ROI</span> than residential due to concentrated high-value materials.
                </p>
                <div class="mt-6 grid grid-cols-2 gap-4">
                    <div class="p-3 bg-green-900/30 rounded-lg border border-green-500/30">
                        <div class="text-green-300 font-medium">Best Investment</div>
                        <div class="text-slate-300 text-sm">Aluminum Recovery</div>
                    </div>
                    <div class="p-3 bg-blue-900/30 rounded-lg border border-blue-500/30">
                        <div class="text-blue-300 font-medium">Best Sector</div>
                        <div class="text-slate-300 text-sm">Commercial</div>
                    </div>
                </div>
            </div>
        </section> -->
    </div>

    <script>
        // Chart instances and state
        let charts = {};
        let currentSection = 0;
        let currentChart = null;
        
        // Waste data for all visualizations
            const wasteData = {
            statewide: {
                'ORGANICS': 34.5, 'MIXED RESIDUE': 16.7, 'PAPER': 15.5, 'INERTS AND OTHER': 12.8,
                'PLASTIC': 8.9, 'SPECIAL WASTE': 4.8, 'METAL': 2.8, 'GLASS': 2.1, 'ELECTRONICS': 1.2, 'HHW': 0.7
            },
            residential: {
                'ORGANICS': 43.2, 'MIXED RESIDUE': 18.1, 'PAPER': 12.3, 'PLASTIC': 9.8,
                'INERTS AND OTHER': 7.2, 'SPECIAL WASTE': 3.9, 'METAL': 2.1, 'GLASS': 2.0, 'ELECTRONICS': 0.8, 'HHW': 0.6
            },
            commercial: {
                'ORGANICS': 25.8, 'MIXED RESIDUE': 19.2, 'PAPER': 18.7, 'INERTS AND OTHER': 15.1,
                'PLASTIC': 8.1, 'SPECIAL WASTE': 5.7, 'METAL': 3.2, 'GLASS': 2.3, 'ELECTRONICS': 1.4, 'HHW': 0.5
            },
            selfhaul: {
                'INERTS AND OTHER': 35.4, 'ORGANICS': 22.1, 'MIXED RESIDUE': 14.3, 'PAPER': 8.9,
                'SPECIAL WASTE': 8.2, 'PLASTIC': 5.1, 'METAL': 3.8, 'GLASS': 1.2, 'ELECTRONICS': 0.7, 'HHW': 0.3
            },
            transfer: {
                'ORGANICS': 31.2, 'MIXED RESIDUE': 17.8, 'PAPER': 16.4, 'INERTS AND OTHER': 13.9,
                'PLASTIC': 9.2, 'SPECIAL WASTE': 4.1, 'METAL': 3.1, 'GLASS': 2.8, 'ELECTRONICS': 1.0, 'HHW': 0.5
            }
        };

        const tonnageData = {
            statewide: {
                'ORGANICS': 13762125, 'MIXED RESIDUE': 6670083, 'PAPER': 6193825, 'INERTS AND OTHER': 5111424,
                'PLASTIC': 3557671, 'SPECIAL WASTE': 1915392, 'METAL': 1118336, 'GLASS': 838358, 'ELECTRONICS': 479359, 'HHW': 279523
            }
        };
        
        // Initialize all charts
        function initializeCharts() {
            // Intro Chart - Treemap Visualization using ECharts
            const introChart = echarts.init(document.getElementById('introCanvas'), null, {
                width: Math.min(window.innerWidth, 1400),
                height: window.innerHeight - 64,
                renderer: 'canvas'
            });
            
            function updateTreemap(sector) {
                const data = wasteData[sector];
                const treemapData = Object.entries(data).map(([name, value]) => ({
                    name: name,
                    value: value,
                    itemStyle: {
                        color: getColorForCategory(name)
                    }
                }));
                
                const option = {
                    series: [{
                        type: 'treemap',
                        width: '90%',
                        height: '85%',
                        top: '12%',
                        left: '5%',
                        roam: false,
                        nodeClick: false,
                        zoomLock: true,
                        data: treemapData,
                        label: {
                            show: true,
                            formatter: function (params) {
                                const value = params.value.toFixed(1);
                                return `{name|${params.name}}\n{value|${value}%}`;
                            },
                            rich: {
                                name: {
                                    fontSize: 14,
                                    color: '#ffffff',
                                    fontWeight: 'bold',
                                    padding: [0, 0, 5, 0]
                                },
                                value: {
                                    fontSize: 12,
                                    color: 'rgba(255,255,255,0.8)',
                                    padding: [5, 0, 0, 0]
                                }
                            }
                        },
                        breadcrumb: { show: false },
                        itemStyle: {
                            borderColor: 'rgba(0,0,0,0.2)',
                            borderWidth: 1,
                            gapWidth: 1,
                            borderRadius: 2
                        },
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowColor: 'rgba(0,0,0,0.5)'
                            }
                        },
                        upperLabel: { show: false },
                        levels: [{
                            itemStyle: {
                                borderColor: 'rgba(0,0,0,0.2)',
                                borderWidth: 1,
                                gapWidth: 1
                            }
                        }],
                        visualDimension: 1
                    }],
                        title: {
                        text: `California Waste Composition 2021 - ${sector.charAt(0).toUpperCase() + sector.slice(1)}`,
                        left: 'center',
                        top: '4%',
                        textStyle: {
                            color: '#f1f5f9',
                            fontSize: 20,
                            fontWeight: 'bold',
                            fontFamily: 'Inter'
                        }
                    },
                    tooltip: {
                        formatter: function(info) {
                            const value = info.value.toFixed(1);
                            return `<div style="font-family: Inter; padding: 3px 6px;">
                                <div style="font-weight: bold; margin-bottom: 4px;">${info.name}</div>
                                <div style="color: rgba(255,255,255,0.9);">${value}%</div>
                            </div>`;
                        },
                        backgroundColor: 'rgba(0,0,0,0.75)',
                        borderColor: 'rgba(255,255,255,0.1)',
                        textStyle: {
                            color: '#fff'
                        },
                        extraCssText: 'backdrop-filter: blur(4px); border-radius: 4px; border: 1px solid rgba(255,255,255,0.1);'
                    }
                };
                
                introChart.setOption(option);
            }

            

            // Add helper function for treemap colors
            function getColorForCategory(category) {
                const colors = {
                    'ORGANICS': '#10b981',
                    'PAPER': '#3b82f6',
                    'PLASTIC': '#f59e0b',
                    'METAL': '#6b7280',
                    'GLASS': '#06b6d4',
                    'ELECTRONICS': '#8b5cf6',
                    'MIXED RESIDUE': '#ef4444',
                    'INERTS AND OTHER': '#94a3b8',
                    'SPECIAL WASTE': '#f97316',
                    'HHW': '#dc2626'
                };
                return colors[category] || '#9ca3af';
            }

            // Remove the previous event listeners that were blocking scroll
            // Only prevent chart-specific zoom behavior
            introChart.setOption({
                preventDefaultMouseMove: false,
                preventDefaultMouseWheel: false,
                preventDefaultTouchStart: false,
                preventDefaultTouchMove: false
            });

            // Initialize with statewide data
            updateTreemap('statewide');
            
            // Add event listener for sector selection
            document.getElementById('sectorSelect').addEventListener('change', function(e) {
                updateTreemap(e.target.value);
            });

            charts.intro = {
                instance: introChart,
                element: document.getElementById('introChart'),
                canvas: document.getElementById('introCanvas')
            };

            // Update resize handler
            window.addEventListener('resize', function() {
                if (introChart) {
                    introChart.resize({
                        width: Math.min(window.innerWidth, 1400),
                        height: window.innerHeight - 64
                    });
                }
            });

            // Comparison Chart initialization and update function
            function updateComparison() {
                const material = document.getElementById('materialSelect')?.value || 'ORGANICS';
                const metric = document.getElementById('metricSelect')?.value || 'percentage';
                
                const sectors = ['statewide', 'residential', 'commercial', 'selfhaul', 'transfer'];
                const values = sectors.map(sector => wasteData[sector][material] || 0);
                const labels = ['Statewide', 'Residential', 'Commercial', 'Self-Haul', 'Transfer'];

                const canvas = document.getElementById('comparisonChartCanvas');
                if (!canvas) {
                    console.error('Canvas element not found');
                    return;
                }

                // Set canvas dimensions
                const container = canvas.parentElement;
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;

                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error('Could not get canvas context');
                    return;
                }
                
                if (window.comparisonChartInstance) {
                    window.comparisonChartInstance.destroy();
                }

                window.comparisonChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: material,
                            data: values,
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(245, 158, 11, 0.8)',
                                'rgba(239, 68, 68, 0.8)',
                                'rgba(139, 92, 246, 0.8)'
                            ],
                            borderColor: [
                                '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'
                            ],
                            borderWidth: 2,
                            // Store original colors for each sector
                            sectorColors: {
                                'Statewide': { bg: 'rgba(59, 130, 246, 0.8)', border: '#3b82f6' },
                                'Residential': { bg: 'rgba(16, 185, 129, 0.8)', border: '#10b981' },
                                'Commercial': { bg: 'rgba(245, 158, 11, 0.8)', border: '#f59e0b' },
                                'Self-Haul': { bg: 'rgba(239, 68, 68, 0.8)', border: '#ef4444' },
                                'Transfer': { bg: 'rgba(139, 92, 246, 0.8)', border: '#8b5cf6' }
                            }
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 20,
                                right: 20,
                                bottom: 40,
                                left: 20
                            }
                        },
                        plugins: {
                            legend: { 
                                display: true,
                                position: 'bottom',
                                onClick: function(e, legendItem, legend) {
                                    const index = legendItem.index;
                                    const chart = legend.chart;
                                    
                                    // Get current visible state
                                    const currentVisibility = !legendItem.hidden;
                                    
                                    // Update the legend item's hidden state
                                    legendItem.hidden = currentVisibility;
                                    
                                    // Filter the data and labels
                                    const allData = [...chart.data.datasets[0].originalData || chart.data.datasets[0].data];
                                    const allLabels = [...chart.data.originalLabels || chart.data.labels];
                                    const sectorColors = chart.data.datasets[0].sectorColors;
                                    
                                    // Store original data if not already stored
                                    if (!chart.data.datasets[0].originalData) {
                                        chart.data.datasets[0].originalData = [...allData];
                                        chart.data.originalLabels = [...allLabels];
                                    }
                                    
                                    // Get all legend items
                                    const legendItems = legend.legendItems;
                                    
                                    // Filter data based on legend visibility
                                    const newData = [];
                                    const newLabels = [];
                                    const newBackgroundColors = [];
                                    const newBorderColors = [];
                                    
                                    legendItems.forEach((item, i) => {
                                        if (!item.hidden) {
                                            newData.push(chart.data.datasets[0].originalData[i]);
                                            const label = chart.data.originalLabels[i];
                                            newLabels.push(label);
                                            // Use stored colors for the sector
                                            newBackgroundColors.push(sectorColors[label].bg);
                                            newBorderColors.push(sectorColors[label].border);
                                        }
                                    });
                                    
                                    // Update chart data and colors
                                    chart.data.datasets[0].data = newData;
                                    chart.data.labels = newLabels;
                                    chart.data.datasets[0].backgroundColor = newBackgroundColors;
                                    chart.data.datasets[0].borderColor = newBorderColors;
                                    
                                    chart.update();
                                },
                                labels: { 
                                    boxWidth: 15,
                                    padding: 20,
                                    color: '#ffffff',
                                    font: {
                                        size: 12,
                                        weight: '500',
                                        family: 'Inter'
                                    },
                                    usePointStyle: true,
                                    generateLabels: function(chart) {
                                        // Store original data if not already stored
                                        if (!chart.data.datasets[0].originalData) {
                                            chart.data.datasets[0].originalData = [...chart.data.datasets[0].data];
                                            chart.data.originalLabels = [...chart.data.labels];
                                        }
                                        
                                        const originalData = chart.data.datasets[0].originalData;
                                        const originalLabels = chart.data.originalLabels;
                                        const sectorColors = chart.data.datasets[0].sectorColors;
                                        
                                        return originalLabels.map((label, i) => ({
                                            text: `${label}: ${originalData[i]}${metric === 'percentage' ? '%' : ' tons'}`,
                                            fillStyle: sectorColors[label].bg,
                                            strokeStyle: sectorColors[label].border,
                                            lineWidth: 1,
                                            hidden: !chart.data.labels.includes(label),
                                            index: i,
                                            fontColor: '#ffffff'
                                        }));
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: `${material} Distribution by Sector`,
                                color: '#f1f5f9',
                                font: { size: 18, weight: 'bold' },
                                padding: { top: 10, bottom: 20 }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(148, 163, 184, 0.1)' },
                                ticks: { 
                                    color: '#94a3b8',
                                    font: {
                                        size: 11
                                    },
                                    callback: function(value) {
                                        return value + (metric === 'percentage' ? '%' : ' tons');
                                    }
                                },
                                title: {
                                    display: true,
                                    text: metric === 'percentage' ? 'Percentage (%)' : 'Tonnage',
                                    color: '#e2e8f0',
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            x: {
                                grid: { color: 'rgba(148, 163, 184, 0.1)' },
                                ticks: { 
                                    color: '#94a3b8',
                                    font: {
                                        size: 11
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Initialize comparison chart when section becomes visible
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        setTimeout(() => {
                            try {
                                updateComparison();
                                charts.correlation = {
                                    instance: window.comparisonChartInstance,
                                    element: document.getElementById('correlationChart'),
                                    canvas: document.getElementById('comparisonChartCanvas'),
                                    update: updateComparison
                                };
                            } catch (error) {
                                console.error('Error initializing comparison chart:', error);
                            }
                        }, 100);
                        observer.disconnect();
                    }
                });
            }, { threshold: 0.1 });

            const correlationChart = document.getElementById('correlationChart');
            if (correlationChart) {
                observer.observe(correlationChart);
            }

            // Add event listeners for comparison chart filters
            document.getElementById('materialSelect')?.addEventListener('change', updateComparison);
            document.getElementById('metricSelect')?.addEventListener('change', updateComparison);

            // Handle window resize
            window.addEventListener('resize', () => {
                if (window.comparisonChartInstance) {
                    updateComparison();
                }
            });

            // Sustainability Chart (replacing Clusters Chart)
            charts.clusters = new Chart(document.getElementById('clustersCanvas'), {
                type: 'radar',
                data: {
                    labels: ['Paper', 'Plastic', 'Glass', 'Metal', 'Organics', 'Electronics'],
                    datasets: [{
                        label: 'Recycling Potential (%)',
                        data: [85, 45, 90, 95, 75, 80],
                        backgroundColor: 'rgba(34, 197, 94, 0.2)',
                        borderColor: '#22c55e',
                        pointBackgroundColor: '#22c55e',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#22c55e'
                    }, {
                        label: 'Current Recycling (%)',
                        data: [35, 15, 25, 70, 20, 40],
                        backgroundColor: 'rgba(239, 68, 68, 0.2)',
                        borderColor: '#ef4444',
                        pointBackgroundColor: '#ef4444',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#ef4444'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    elements: {
                        line: { borderWidth: 3 }
                    },
                    scales: {
                        r: {
                            angleLines: { 
                                color: 'rgba(148, 163, 184, 0.2)' 
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)'
                            },
                            pointLabels: {
                                color: '#e2e8f0',
                                font: {
                                    size: 12,
                                    family: 'Inter'
                                }
                            },
                            ticks: {
                                color: '#94a3b8',
                                backdropColor: 'transparent',
                                font: {
                                    size: 10
                                }
                            },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#e2e8f0',
                                font: {
                                    size: 12,
                                    family: 'Inter'
                                },
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        title: {
                            display: true,
                            text: 'Material Recovery Analysis',
                            color: '#f1f5f9',
                            font: {
                                size: 18,
                                weight: 'bold',
                                family: 'Inter'
                            },
                            padding: {
                                top: 20,
                                bottom: 20
                            }
                        }
                    }
                }
            });

            // ML Performance
            
            charts.clusters = new Chart(document.getElementById('mlCanvas'), {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'High-Value Recyclables',
                        data: [{x: 85, y: 1500, r: 15}, {x: 78, y: 1200, r: 12}, {x: 92, y: 1800, r: 18}],
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: '#3b82f6'
                    }, {
                        label: 'Organic Streams',
                        data: [{x: 45, y: 200, r: 25}, {x: 52, y: 180, r: 22}, {x: 38, y: 220, r: 28}],
                        backgroundColor: 'rgba(16, 185, 129, 0.6)',
                        borderColor: '#10b981'
                    }, {
                        label: 'Problem Materials',
                        data: [{x: 15, y: 50, r: 20}, {x: 12, y: 45, r: 18}, {x: 18, y: 55, r: 22}],
                        backgroundColor: 'rgba(239, 68, 68, 0.6)',
                        borderColor: '#ef4444'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            title: { display: true, text: 'Recovery Rate (%)', color: '#e2e8f0' },
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        y: { 
                            title: { display: true, text: 'Value ($/ton)', color: '#e2e8f0' },
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#e2e8f0' } },
                        title: {
                            display: true,
                            text: 'Material Behavioral Clusters',
                            color: '#f1f5f9',
                            font: { size: 18, weight: 'bold' }
                        }
                    }
                }
            });

            // Forecasting
            // charts.forecast = new Chart(document.getElementById('forecastCanvas'), {
            //     type: 'line',
            //     data: {
            //         labels: ['2021', '2022', '2023', '2024', '2025'],
            //         datasets: [{
            //             label: 'Organic Waste (Million Tons)',
            //             data: [12.5, 13.1, 13.8, 14.6, 15.4],
            //             borderColor: '#10b981',
            //             backgroundColor: 'rgba(16, 185, 129, 0.1)',
            //             fill: true,
            //             tension: 0.4
            //         }, {
            //             label: 'Total Waste (Million Tons)',
            //             data: [35.5, 36.2, 37.1, 38.0, 38.9],
            //             borderColor: '#3b82f6',
            //             backgroundColor: 'rgba(59, 130, 246, 0.1)',
            //             fill: true,
            //             tension: 0.4
            //         }]
            //     },
            //     options: {
            //         responsive: true,
            //         maintainAspectRatio: false,
            //         scales: {
            //             y: { 
            //                 beginAtZero: true,
            //                 ticks: { color: '#94a3b8' },
            //                 grid: { color: 'rgba(148, 163, 184, 0.1)' }
            //             },
            //             x: { 
            //                 ticks: { color: '#94a3b8' },
            //                 grid: { color: 'rgba(148, 163, 184, 0.1)' }
            //             }
            //         },
            //         plugins: {
            //             legend: { labels: { color: '#e2e8f0' } },
            //             title: {
            //                 display: true,
            //                 text: 'Waste Generation Forecast',
            //                 color: '#f1f5f9',
            //                 font: { size: 18, weight: 'bold' }
            //             }
            //         }
            //     }
            // });

            // Carbon Impact
            charts.carbon = new Chart(document.getElementById('carbonCanvas'), {
                type: 'doughnut',
                data: {
                    labels: ['Treated Wood (18.7%)', 'Plastic Products (16.2%)', 'Mixed Residue (14.8%)', 'Food Waste (12.3%)', 'Electronics (11.5%)', 'Other Materials (26.5%)'],
                    datasets: [{
                        data: [18.7, 25.3, 15.2, 12.8, 8.4, 19.6],
                        backgroundColor: [
                            '#ef4444', '#10b981', '#8b5cf6', 
                            '#3b82f6', '#f59e0b', '#6b7280'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#e2e8f0', font: { size: 14 } }
                        },
                        title: {
                            display: true,
                            text: 'Carbon Emission Distribution (3.1M tons CO₂e)',
                            color: '#f1f5f9',
                            font: { size: 18, weight: 'bold' }
                        }
                    }
                }
            });

            // Optimization Matrix
            charts.optimization = new Chart(document.getElementById('optimizationCanvas'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Aluminum',
                        data: [{x: 95, y: 1500, r: 20}],
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: '#10b981'
                    }, {
                        label: 'Paper',
                        data: [{x: 65, y: 120, r: 15}],
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: '#3b82f6'
                    }, {
                        label: 'Plastic',
                        data: [{x: 25, y: 80, r: 12}],
                        backgroundColor: 'rgba(139, 92, 246, 0.8)',
                        borderColor: '#8b5cf6'
                    }, {
                        label: 'Organics',
                        data: [{x: 40, y: 50, r: 18}],
                        backgroundColor: 'rgba(245, 158, 11, 0.8)',
                        borderColor: '#f59e0b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            title: { display: true, text: 'Recovery Rate (%)', color: '#e2e8f0' },
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        y: { 
                            title: { display: true, text: 'Economic Value ($/ton)', color: '#e2e8f0' },
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#e2e8f0' } },
                        title: {
                            display: true,
                            text: 'Economic-Environmental Optimization Matrix',
                            color: '#f1f5f9',
                            font: { size: 18, weight: 'bold' }
                        }
                    }
                }
            });

            // After initializing charts, store them in the charts object for easy access
            const chartContainers = document.querySelectorAll('.chart-container');
            chartContainers.forEach(container => {
                const id = container.id.replace('Chart', '');
                charts[id] = {
                    element: container,
                    canvas: container.querySelector('canvas')
                };
            });
        }

        // Show specific chart
        function updateCharts(sectionIndex, scrollProgress) {
            const sections = document.querySelectorAll('.narrative-section');
            const section = sections[sectionIndex];
            const chartId = section.dataset.chart;
            const targetChart = document.getElementById(chartId + 'Chart');

            if (!targetChart) {
                console.error('Chart not found:', chartId);
                return;
            }

            // If we're switching to a new chart
            if (currentChart !== targetChart) {
                console.log('Switching to chart:', chartId); // Debug log

                // Hide all charts first
                document.querySelectorAll('.chart-container').forEach(container => {
                    container.classList.remove('visible', 'active');
                });

                // Show new chart
                targetChart.classList.add('visible');
                currentChart = targetChart;
            }

            // Update chart state based on scroll progress
            if (currentChart) {
                if (scrollProgress < 0.4) {
                    currentChart.classList.remove('active');
                } else {
                    currentChart.classList.add('active');
                }
            }
        }

        // Update progress and section
        function updateProgress() {
            const scrollTop = window.pageYOffset;
            const docHeight = document.documentElement.scrollHeight - window.innerHeight;
            const progress = (scrollTop / docHeight) * 100;
            
            document.getElementById('progressFill').style.width = progress + '%';
            
            // Determine current section
            const sections = document.querySelectorAll('.narrative-section');
            let foundCurrentSection = false;
            
            sections.forEach((section, index) => {
                const rect = section.getBoundingClientRect();
                const panel = section.querySelector('.narrative-panel');
                
                // Calculate the progress within this section
                const sectionProgress = -rect.top / (rect.height - window.innerHeight);
                
                if (sectionProgress >= 0 && sectionProgress <= 1 && !foundCurrentSection) {
                    foundCurrentSection = true;
                    
                    if (currentSection !== index) {
                        console.log('Switching to section:', index); // Debug log
                        currentSection = index;
                        updateSectionIndicator(index);
                    }
                    
                    if (panel) {
                        if (sectionProgress < 0.4) {
                            panel.classList.add('active');
                            panel.classList.remove('exit');
                        } else {
                            panel.classList.remove('active');
                            panel.classList.add('exit');
                        }
                    }
                    
                    updateCharts(index, sectionProgress);
                }
            });
        }

        // Update section indicator
        function updateSectionIndicator(sectionIndex) {
            const sectionNames = [
                'Introduction', 'Recovery Potential', 'Hidden Patterns',
                'ML Performance', 'Forecasting', 'Carbon Impact', 'Optimization'
            ];
            
            document.getElementById('currentSection').textContent = sectionNames[sectionIndex] || 'Introduction';
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing...'); // Debug log
            
            // Initialize charts first
            initializeCharts();
            
            // Hide all charts initially
            document.querySelectorAll('.chart-container').forEach(container => {
                container.classList.remove('visible', 'active');
            });
            
            // Show first chart in background state
            const firstChart = document.getElementById('introChart');
            if (firstChart) {
                console.log('Setting up first chart'); // Debug log
                firstChart.classList.add('visible');
                currentChart = firstChart;
            } else {
                console.error('First chart not found!'); // Debug log
            }
            
            updateProgress();
            
            // Add scroll event listener with throttling
            let ticking = false;
            window.addEventListener('scroll', function() {
                if (!ticking) {
                    window.requestAnimationFrame(function() {
                        updateProgress();
                        ticking = false;
                    });
                    ticking = true;
                }
            });
            
            window.addEventListener('resize', function() {
                Object.values(charts).forEach(chart => {
                    if (chart.instance && typeof chart.instance.resize === 'function') {
                        chart.instance.resize();
                    }
                });
            });
        });
    </script>
</body>
</html>